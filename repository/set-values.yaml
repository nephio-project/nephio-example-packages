# Copyright 2023 The Nephio Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

apiVersion: fn.kpt.dev/v1alpha1
kind: StarlarkRun
metadata: # kpt-merge: /generate-values
  name: generate-values
  annotations:
    config.kubernetes.io/local-config: "true"
    internal.kpt.dev/upstream-identifier: fn.kpt.dev|StarlarkRun|default|generate-values
source: |-
  load("krmfn.star", "krmfn")
  def set_values(resources):
    # this package can be cloned manually and used without injection; in that case base
    # the repository name on the package name
    for r in resources:
      if krmfn.match_gvk(r, "v1", "ConfigMap") and krmfn.match_name(r, "kptfile.kpt.dev"):
        clusterName = r["data"]["name"]
    # if a WorkloadCluster exists, and was injected, then use that for the name
    for r in resources:
      if krmfn.match_gvk(r, "infra.nephio.org/v1alpha1", "WorkloadCluster") and "annotations" in r["metadata"] and "kpt.dev/injected-resource" in r["metadata"]["annotations"]:
        clusterName = r["spec"]["clusterName"]
    for r in resources:
      if krmfn.match_gvk(r, "infra.nephio.org/v1alpha1", "Repository"):
        r["metadata"]["name"] = clusterName
        r["spec"]["description"] = clusterName + " repository"
      if krmfn.match_gvk(r, "config.porch.kpt.dev/v1alpha1", "Repository"):
        r["metadata"]["name"] = clusterName
        r["spec"]["git"]["repo"] = "http://172.18.0.200:3000/nephio/" + clusterName + ".git"
        r["spec"]["git"]["secretRef"]["name"] = clusterName + "-access-token-porch"
        if clusterName == "mgmt-staging":
           r["spec"]["deployment"] = False
           r["metadata"]["annotations"]["nephio.org/staging"] = "true"
      if krmfn.match_gvk(r, "infra.nephio.org/v1alpha1", "Token"):
        r["metadata"]["name"] = clusterName + "-access-token-porch"
        if "annotations" in r["metadata"] and "nephio.org/app" in r["metadata"]["annotations"] and "configsync" in r["metadata"]["annotations"]["nephio.org/app"]:
          r["metadata"]["name"] = clusterName + "-access-token-configsync"
          if clusterName == "mgmt" or clusterName == "mgmt-staging":
            r["metadata"]["namespace"] = "config-management-system"
  set_values(ctx.resource_list["items"])
